# PostgreSQL Storage & Architecture Decisions
## Kubernetes PV vs Azure Managed PostgreSQL (Platform Engineer Guide)

This document explains **how to run PostgreSQL safely in production**, focusing on:
- Storage choices (block vs file)
- Why PostgreSQL needs disks
- Kubernetes Persistent Volumes
- Azure Managed PostgreSQL benefits
- High Availability, security, backups

Written for **Platform / DevOps Engineers**, not DBAs.

---

## 1. Core Mental Model (Start Here)

PostgreSQL is:
- A **stateful** system
- A **source of truth**
- Extremely **storage-sensitive**

Bad storage choices = data loss or corruption.

---

## 2. What PostgreSQL Needs From Storage (First Principles)

PostgreSQL requires:
- Low write latency
- Predictable IOPS
- Correct `fsync` behavior
- POSIX filesystem semantics
- Single-writer safety

If storage lies about durability ‚Üí PostgreSQL breaks.

---

## 3. Storage Options for PostgreSQL on Kubernetes

### 3.1 Block Storage (RECOMMENDED)

#### What it is
- Raw disk attached to a pod
- Mounted as a filesystem
- Acts like a real hard drive

#### Azure examples
- Azure Managed Disk
- Premium SSD
- Ultra Disk

#### Architecture

```
Postgres Pod
    |
Persistent Volume
    |
Azure Managed Disk (Block)
```

#### Why this works best
- Low latency
- Stable performance
- Correct WAL writes
- Safe fsync semantics

üëâ **Default choice for production PostgreSQL**.

---

### 3.2 Network File Storage (NOT RECOMMENDED)

#### What it is
- Shared network filesystem
- Multiple pods can mount

#### Azure example
- Azure Files (NFS/SMB)

#### Problems for PostgreSQL
- Higher latency
- Unreliable fsync guarantees
- Network hiccups affect DB
- Unpredictable performance

#### When acceptable
- Dev / test
- Low-load environments

üëâ **Avoid for production OLTP workloads**.

---

### 3.3 Local Node Disk (ADVANCED, RISKY)

#### What it is
- Disk physically attached to node

#### Pros
- Very fast

#### Cons
- Node failure = data loss
- Manual recovery required
- Complex operations

üëâ **Only for highly mature teams**.

---

## 4. Kubernetes StorageClass Selection

You don‚Äôt pick disks directly. You pick a **StorageClass**.

Recommended for AKS:
- `managed-premium`
- `managed-csi-premium`
- `ultra-disk` (very high IOPS)

StorageClass ensures:
- Dynamic disk provisioning
- Correct performance tier

---

## 5. PostgreSQL on Kubernetes ‚Äì Full Architecture

```
Application
    |
    |  (DNS / Service)
    v
Postgres Service
    |
    v
Postgres Pod (Primary)
    |
Persistent Volume
    |
Azure Managed Disk
```

Replica pods have their own PVs.

---

## 6. High Availability (HA) for PostgreSQL

### Primary + Replica Model

```
App ‚Üí Primary Postgres ‚Üí Replica Postgres
```

- Primary handles writes
- Replica copies data
- Failover promotes replica

Platform Engineer responsibilities:
- Automatic failover
- Stable endpoints
- App reconnect behavior

---

## 7. Backups, RPO, RTO

### Backups

- Automated
- Stored outside cluster
- Restore-tested

---

### RPO (Recovery Point Objective)

> How much data loss is acceptable

Example:
- RPO = 5 minutes

---

### RTO (Recovery Time Objective)

> How fast system must recover

Example:
- RTO = 10 minutes

---

## 8. Security (PostgreSQL)

Layers:
- No public IPs
- Private networking
- TLS in transit
- Disk encryption at rest
- Identity-based auth

Golden rule:
> Database is never publicly accessible.

---

## 9. Azure Managed PostgreSQL ‚Äì Why Many Teams Choose It

### What Azure Managed PostgreSQL Gives You

Azure handles:
- Storage management
- Backups
- Patching
- High availability
- Monitoring

You focus on:
- Access control
- Networking
- Performance tuning

---

### Managed PostgreSQL Architecture

```
Application (AKS)
    |
Private Endpoint
    |
Azure Managed PostgreSQL
    |
Azure Managed Storage
```

---

## 10. Managed PostgreSQL vs Kubernetes PostgreSQL

| Aspect | Managed PostgreSQL | K8s PostgreSQL |
|-----|------------------|--------------|
| Ops effort | Low | High |
| HA | Built-in | You manage |
| Backups | Automatic | You configure |
| Scaling | Simple | Complex |
| Control | Less | Full |

---

## 11. Platform Engineer Checklist

When running PostgreSQL, you must ensure:
- Correct storage type
- Backups tested
- HA validated
- Monitoring alerts
- Secure access
- Cost awareness

---

## 12. Interview-Ready Summary

> ‚ÄúPostgreSQL requires block storage for correctness and performance. On Kubernetes, this means block-backed persistent volumes such as Azure Managed Disks. Network file systems are risky for production workloads. For cloud-first environments, Azure Managed PostgreSQL is often preferred because it offloads storage, backups, patching, and HA, allowing platform teams to focus on reliability and security rather than database internals.‚Äù

---

**If you can explain this document calmly, you are operating at senior platform-engineer level.**

